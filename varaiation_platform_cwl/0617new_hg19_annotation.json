{
    "class": "Workflow",
    "cwlVersion": "v1.0",
    "id": "hg19_annotation",
    "label": "hg19_annotation",
    "$namespaces": {
        "sbg": "https://www.sevenbridges.com/"
    },
    "inputs": [
        {
            "id": "annoPath",
            "type": "Directory?",
            "sbg:x": -183,
            "sbg:y": -620.5652465820312
        },
        {
            "id": "inputType",
            "type": "string?",
            "default": "file",
            "sbg:exposed": true
        },
        {
            "id": "annoCol",
            "type": "string?",
            "default": "Gene.refGene",
            "sbg:exposed": true
        },
        {
            "id": "output_2",
            "type": "string?",
            "default": "annotated.txt",
            "sbg:exposed": true
        },
        {
            "id": "annoFileList",
            "type": "string[]?",
            "default": [
                "annotation",
                "OMIM",
                "GO",
                "DO",
                "HPO",
                "KEGG",
                "WIKI",
                "REACTOME",
                "BIOCARTA",
                "HALLMARK",
                "PID"
            ],
            "sbg:exposed": true
        },
        {
            "id": "geneAlias",
            "type": "string?",
            "default": "yes",
            "sbg:exposed": true
        },
        {
            "id": "raw_vcf",
            "type": "File?",
            "sbg:x": -752.7391357421875,
            "sbg:y": -335.86956787109375
        },
        {
            "id": "annovar_db",
            "type": "Directory?",
            "sbg:x": -764.1738891601562,
            "sbg:y": -83.6956558227539
        },
        {
            "id": "ref_version",
            "type": "string?",
            "sbg:x": -731.1738891601562,
            "sbg:y": -467.7391357421875
        },
        {
            "id": "splicing_threshold",
            "type": "int?",
            "sbg:x": -728.1738891601562,
            "sbg:y": -592.2608642578125
        },
        {
            "id": "output",
            "type": "string?",
            "sbg:x": -765.2608642578125,
            "sbg:y": -210.69564819335938
        }
    ],
    "outputs": [
        {
            "id": "output_1",
            "outputSource": [
                "geneanno/output_1"
            ],
            "type": "File?",
            "sbg:x": -35.65217208862305,
            "sbg:y": -638.95654296875
        },
        {
            "id": "output_vcf",
            "outputSource": [
                "new_annovar_function/output_vcf"
            ],
            "type": "File?",
            "sbg:x": -455.4347839355469,
            "sbg:y": 171.82608032226562
        },
        {
            "id": "output_txt",
            "outputSource": [
                "new_annovar_function/output_txt"
            ],
            "type": "File?",
            "sbg:x": -456.86956787109375,
            "sbg:y": 45.34782791137695
        },
        {
            "id": "output_avinput",
            "outputSource": [
                "new_annovar_function/output_avinput"
            ],
            "type": "File?",
            "sbg:x": -456.9130554199219,
            "sbg:y": -80.9565200805664
        },
        {
            "id": "sample_name",
            "outputSource": [
                "new_annovar_filter/sample_name"
            ],
            "type": "File?",
            "sbg:x": 190.19732666015625,
            "sbg:y": -523.003662109375
        },
        {
            "id": "filter_transed_vcf",
            "outputSource": [
                "txt2vcf/filter_transed_vcf"
            ],
            "type": "File?",
            "sbg:x": 436.4056396484375,
            "sbg:y": -480.4649658203125
        }
    ],
    "steps": [
        {
            "id": "geneanno",
            "in": [
                {
                    "id": "inputType",
                    "source": "inputType"
                },
                {
                    "id": "inputFile",
                    "source": "new_annovar_function/output_txt"
                },
                {
                    "id": "annoCol",
                    "source": "annoCol"
                },
                {
                    "id": "annoPath",
                    "source": "annoPath"
                },
                {
                    "id": "output",
                    "source": "output_2"
                },
                {
                    "id": "annoFileList",
                    "source": [
                        "annoFileList"
                    ]
                },
                {
                    "id": "geneAlias",
                    "source": "geneAlias"
                }
            ],
            "out": [
                {
                    "id": "output_1"
                }
            ],
            "run": {
                "class": "CommandLineTool",
                "cwlVersion": "v1.0",
                "$namespaces": {
                    "sbg": "https://www.sevenbridges.com/"
                },
                "id": "geneanno",
                "baseCommand": [
                    "python",
                    "geneAnno.py",
                    "wqrwr4"
                ],
                "inputs": [
                    {
                        "id": "inputType",
                        "type": "string?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--inputType"
                        }
                    },
                    {
                        "id": "gene",
                        "type": "string?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--gene"
                        }
                    },
                    {
                        "id": "inputFile",
                        "type": "File?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--inputFile"
                        }
                    },
                    {
                        "id": "annoCol",
                        "type": "string?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--annoCol"
                        }
                    },
                    {
                        "id": "geneMulti",
                        "type": "string?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--geneMulti"
                        }
                    },
                    {
                        "id": "annoPath",
                        "type": "Directory?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--annoPath"
                        }
                    },
                    {
                        "id": "genesep",
                        "type": "string?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--genesep"
                        }
                    },
                    {
                        "default": "out.txt",
                        "id": "output",
                        "type": "string?",
                        "inputBinding": {
                            "position": 100,
                            "prefix": "--output"
                        }
                    },
                    {
                        "id": "annoFileList",
                        "type": "string[]?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--annoFileList",
                            "itemSeparator": ","
                        }
                    },
                    {
                        "id": "geneAlias",
                        "type": "string?",
                        "inputBinding": {
                            "position": 0,
                            "prefix": "--geneAlias"
                        }
                    }
                ],
                "outputs": [
                    {
                        "id": "output_1",
                        "type": "File?",
                        "outputBinding": {
                            "glob": "$(inputs.output)"
                        }
                    }
                ],
                "label": "geneAnno",
                "requirements": [
                    {
                        "class": "DockerRequirement",
                        "dockerPull": "harbor.bio-it.cn:5000/library/py38_r403:anno"
                    },
                    {
                        "class": "InitialWorkDirRequirement",
                        "listing": [
                            {
                                "entryname": "geneAnno.py",
                                "entry": "import warnings\r\nwarnings.filterwarnings(\"ignore\")\r\nimport pandas as pd\r\nimport numpy as np\r\nimport sys\r\nimport os\r\n\r\nfrom optparse import OptionParser\r\n\r\nparser = OptionParser()\r\nparser.add_option('--inputType', dest=\"inputType\", default = \"list\", help=\"list or file\")\r\nparser.add_option('--gene', dest=\"gene\", default = \"\", help=\"if inputType list, gene list\")\r\nparser.add_option('--inputFile', dest=\"inputFile\", default = \"\", help=\"if inputType file, gene file\")\r\nparser.add_option('--annoCol', dest=\"annoCol\", default = \"\", help=\"if inputType file, gene col\")\r\nparser.add_option('--geneMulti', dest=\"geneMulti\", default = \" \", help=\"if inputType file, gene multi, yes or no\")\r\nparser.add_option('--genesep', dest=\"genesep\", default = \" \", help=\"if inputType file, if geneMulti yes, gene sep\")\r\nparser.add_option('--annoPath', dest=\"annoPath\", default = \" \", help=\"annoPath\")\r\nparser.add_option('--output', dest=\"output\", default = \" \", help=\"output\")\r\nparser.add_option('--annoFileList', dest=\"annoFileList\", default = \" \", help=\"annoFileList, comma join\")\r\nparser.add_option('--geneAlias', default = \" \", dest=\"geneAlias\", help=\"geneAlias, yes or no\")\r\n(options, args) = parser.parse_args()\r\nfor i in \"inputType,gene,inputFile,annoCol,geneMulti,genesep,annoPath,output,annoFileList,geneAlias\".split(\",\"):\r\n    exec(i+\"=options.\"+i)\r\n\r\n\r\n\r\ndef read_data(inputFile,write = False,writeData = None):\r\n    fileType = inputFile.split(\".\")[-1]\r\n    if fileType == \"xlsx\":\r\n        if write:\r\n            writeData.to_excel(inputFile)\r\n        else:\r\n            transData = pd.read_excel(inputFile,dtype=\"str\")\r\n    else:\r\n        if fileType in [\"txt\",\"tsv\"]:\r\n            sep = \"\\t\"\r\n        else:\r\n            sep=\",\"\r\n        if write:\r\n            writeData.to_csv(inputFile,sep=sep,index = False)\r\n        else:\r\n            transData = pd.read_csv(inputFile,dtype=\"str\",sep=sep)\r\n    if not write:\r\n        return transData\r\n\r\ndef trans_int(x):\r\n    if not pd.isnull(x):\r\n        x = int(x)\r\n    return x\r\ndef trans_str(x):\r\n    if not pd.isnull(x):\r\n        x = str(int(x))\r\n    return x\r\n    \r\nif inputType == \"list\":\r\n    annoCol = \"search\"\r\n    gene = gene.replace(\",\",\"\\n\").replace(\"\\n\",\"\\t\").replace(\" \",\"\\t\").split(\"\\t\")\r\n    transData = pd.DataFrame(gene,columns=[annoCol])\r\n    transData = transData[transData[annoCol] != \"\"]\r\n    transData.index = range(len(transData))\r\nelif inputType == \"file\":\r\n    transData = read_data(inputFile)\r\ngeneTrans = pd.read_csv(os.path.join(annoPath,\"geneTrans.csv.gz\"),dtype=\"str\")\r\nif geneAlias == \"no\":\r\n    geneTrans = geneTrans[geneTrans[\"type\"] != \"synonyms\"]\r\ntransDataGene = transData[[annoCol]]\r\ntransDataGene.columns = [\"up\"]\r\ntransDataGene[\"up\"] = transDataGene[\"up\"].str.upper()\r\nif geneMulti == \"yes\":\r\n    transDataGene[\"order\"] = transDataGene.index\r\n    transDataGene = transDataGene.drop(\"up\", axis=1).join(transDataGene[\"up\"].str.split(genesep, expand=True).stack().reset_index(level=1, drop=True).rename(\"up\"))\r\ntransDataGene = pd.merge(transDataGene,geneTrans[[\"up\",\"id\"]],on=\"up\",how=\"left\")\r\nif geneMulti == \"yes\":\r\n    transDataGene[\"id\"] = transDataGene[\"id\"].apply(trans_int)\r\n    transDataGene = transDataGene.sort_values(by=\"id\").drop_duplicates(subset= [\"order\"]).sort_values(by=\"order\")\r\n    transDataGene[\"id\"] = transDataGene[\"id\"].apply(trans_str)\r\ntransDataGene = transDataGene[[\"id\"]]    \r\nannoFileList = annoFileList.split(\",\")\r\nfor annoFile in annoFileList:\r\n    anno = pd.read_csv(os.path.join(annoPath,\"DB\"+annoFile+\".csv.gz\"),dtype=\"str\")\r\n    for i in anno.columns:\r\n        if i != \"id\":\r\n            print({i:annoFile+\"_\"+i})\r\n            anno.rename(columns={i:annoFile+\"_\"+i},inplace=True)\r\n    transDataGene = pd.merge(transDataGene,anno,on=\"id\",how=\"left\")\r\ntransData = pd.concat([transData,transDataGene.drop(\"id\",axis =1)],axis=1)\r\ntransData.fillna(\".\",inplace=True)\r\n\r\nread_data(output,write = True,writeData = transData)\r\n# import time \r\n# time.sleep(100)",
                                "writable": false
                            }
                        ]
                    },
                    {
                        "class": "InlineJavascriptRequirement"
                    }
                ]
            },
            "label": "geneAnno",
            "sbg:x": -109.23838806152344,
            "sbg:y": -421.1640930175781
        },
        {
            "id": "new_annovar_function",
            "in": [
                {
                    "id": "raw_vcf",
                    "source": "raw_vcf"
                },
                {
                    "id": "annovar_db",
                    "source": "annovar_db"
                },
                {
                    "id": "ref_version",
                    "source": "ref_version"
                },
                {
                    "id": "splicing_threshold",
                    "source": "splicing_threshold"
                },
                {
                    "id": "output",
                    "source": "output"
                }
            ],
            "out": [
                {
                    "id": "output_vcf"
                },
                {
                    "id": "output_txt"
                },
                {
                    "id": "output_avinput"
                }
            ],
            "run": {
                "class": "CommandLineTool",
                "cwlVersion": "v1.0",
                "$namespaces": {
                    "sbg": "https://www.sevenbridges.com/"
                },
                "id": "new_annovar_function",
                "baseCommand": [
                    "table_annovar.pl"
                ],
                "inputs": [
                    {
                        "id": "raw_vcf",
                        "type": "File?",
                        "inputBinding": {
                            "position": 1
                        }
                    },
                    {
                        "id": "annovar_db",
                        "type": "Directory?",
                        "inputBinding": {
                            "position": 2
                        }
                    },
                    {
                        "id": "ref_version",
                        "type": "string?",
                        "inputBinding": {
                            "position": 3,
                            "prefix": "-buildver"
                        }
                    },
                    {
                        "default": "refGene,avsnp150,popfreq_all_20150413,gnomad211_exome,clinvar_20210501,dbnsfp42a,rmsk,tfbsConsSites,intervar_20180118",
                        "id": "protocol",
                        "type": "string?",
                        "inputBinding": {
                            "position": 4,
                            "prefix": "-protocol"
                        }
                    },
                    {
                        "default": "g,f,f,f,f,f,r,r,f",
                        "id": "operation",
                        "type": "string?",
                        "inputBinding": {
                            "position": 5,
                            "prefix": "-operation"
                        }
                    },
                    {
                        "default": ".",
                        "id": "NA_string",
                        "type": "string?",
                        "inputBinding": {
                            "position": 6,
                            "prefix": "-nastring"
                        }
                    },
                    {
                        "id": "splicing_threshold",
                        "type": "int?",
                        "inputBinding": {
                            "position": 7,
                            "prefix": "-intronhgvs"
                        }
                    },
                    {
                        "default": true,
                        "id": "rm_tmp",
                        "type": "boolean?",
                        "inputBinding": {
                            "position": 8,
                            "prefix": "-remove"
                        }
                    },
                    {
                        "default": true,
                        "id": "confirm_vcfinput",
                        "type": "boolean?",
                        "inputBinding": {
                            "position": 9,
                            "prefix": "-vcfinput"
                        }
                    },
                    {
                        "id": "output",
                        "type": "string?",
                        "inputBinding": {
                            "position": 11,
                            "prefix": "-out"
                        }
                    },
                    {
                        "default": true,
                        "id": "other_info",
                        "type": "boolean?",
                        "inputBinding": {
                            "position": 10,
                            "prefix": "-otherinfo"
                        }
                    }
                ],
                "outputs": [
                    {
                        "id": "output_vcf",
                        "type": "File?",
                        "outputBinding": {
                            "glob": "$(inputs.output)*_multianno.vcf"
                        }
                    },
                    {
                        "id": "output_txt",
                        "type": "File?",
                        "outputBinding": {
                            "glob": "$(inputs.output)*_multianno.txt"
                        }
                    },
                    {
                        "id": "output_avinput",
                        "type": "File?",
                        "outputBinding": {
                            "glob": "$(inputs.output).avinput"
                        }
                    }
                ],
                "label": "New_annovar_function",
                "requirements": [
                    {
                        "class": "DockerRequirement",
                        "dockerPull": "harbor.bio-it.cn:5000/library/annovar:latest"
                    },
                    {
                        "class": "InlineJavascriptRequirement"
                    }
                ]
            },
            "label": "New_annovar_function",
            "sbg:x": -568.5652465820312,
            "sbg:y": -327.65216064453125
        },
        {
            "id": "new_annovar_filter",
            "in": [
                {
                    "id": "Input_file",
                    "source": "geneanno/output_1"
                },
                {
                    "id": "sample_name_in",
                    "source": "output"
                }
            ],
            "out": [
                {
                    "id": "sample_name"
                }
            ],
            "run": {
                "class": "CommandLineTool",
                "cwlVersion": "v1.0",
                "$namespaces": {
                    "sbg": "https://www.sevenbridges.com/"
                },
                "id": "new_annovar_filter",
                "baseCommand": [
                    "Rscript",
                    "Merge_res.R"
                ],
                "inputs": [
                    {
                        "id": "Input_file",
                        "type": "File?",
                        "inputBinding": {
                            "position": 0
                        }
                    },
                    {
                        "id": "sample_name_in",
                        "type": "string?",
                        "inputBinding": {
                            "position": 1
                        }
                    }
                ],
                "outputs": [
                    {
                        "id": "sample_name",
                        "type": "File?",
                        "outputBinding": {
                            "glob": "$(inputs.sample_name_in).filterd.txt"
                        }
                    }
                ],
                "label": "New_annovar_filter",
                "requirements": [
                    {
                        "class": "DockerRequirement",
                        "dockerPull": "harbor.bio-it.cn:5000/library/clusterprofile:R4.0.0"
                    },
                    {
                        "class": "InitialWorkDirRequirement",
                        "listing": [
                            {
                                "entryname": "Merge_res.R",
                                "entry": "#!/usr/bin/Rscript\nrepos='https://mirrors.ustc.edu.cn/CRAN/'\n#Dowload pkg\ninstall.packages('readr',repos=repos)\ninstall.packages('dplyr',repos=repos)\ninstall.packages('stringr',repos=repos)\n\n\n#Library\nlibrary(readr)\nlibrary(dplyr)\nlibrary(stringr)\n\n#arg\narg <- commandArgs(TRUE)\ninput_file <-arg[1]\nsample_name <- arg[2]\n\na <- read_delim(file = input_file , '\\t', escape_double = FALSE, trim_ws = TRUE )\nmax_freq <- apply(a[,c(13,16,19,22,27,29,35,39)],1,max, na.rm = F )\na$max_maf <- max_freq\na_num <- a[which(a$max_maf!='.'),]\na_string <- a[which(a$max_maf=='.'),]\nstr(a_num$max_maf)\na$max_maf[which(a_num$max_maf =='1.')]='1'\na$max_maf[which(a_num$max_maf =='0.')]='0'\na_num$max_maf <- as.numeric(a_num$max_maf)\nstr(a_num$max_maf)\n\ntable(a$Func.refGene)\nfilter_rule_region <- c(\"intergenic\",\"intron\",\"intronic\",\"ncRNA_intronic\",\"ncRNA_exonic\",\"ncRNA_exonic;splicing\",\"ncRNA_splicing\",\"ncRNA_UTR5\",\"UTR3\",\"UTR5\",'upstream;downstream',' upstream',\n                        'UTR3;UTR5','UTR5;UTR3','downstream')\nfilter_res_region_num <- filter(a_num,!(Func.refGene %in% filter_rule_region ))\nfilter_res_region_string <- filter(a_string,!(Func.refGene %in% filter_rule_region ))\nfilter_rule_function <- c('synonymous SNV')\nfilter_res_function_string <- filter(filter_res_region_string,!(Func.refGene %in% filter_rule_region ))\nfilter_res_function_num <- filter(filter_res_region_num,!(Func.refGene %in% filter_rule_region ))\n\nfilter_res_MAF_num <- filter_res_function_num[which(filter_res_function_num$max_maf < 0.01),]\nfilter_res_MAF_string <- filter_res_function_string[which(filter_res_function_string$max_maf < 0.01),]\n\nfilter_res_MAF <- rbind(filter_res_MAF_num,filter_res_MAF_string)\nfinal_res <- cbind(filter_res_MAF[,1:190],filter_res_MAF[,204:218],filter_res_MAF[,191:203])\nwrite.table(final_res,paste(sample_name,'.filterd.txt',sep=''),row.names = F,sep = '\\t',quote = F)\n",
                                "writable": true
                            }
                        ]
                    },
                    {
                        "class": "InlineJavascriptRequirement"
                    }
                ]
            },
            "label": "New_annovar_filter",
            "sbg:x": 134.89694213867188,
            "sbg:y": -357.1020202636719
        },
        {
            "id": "txt2vcf",
            "in": [
                {
                    "id": "txt2vcf",
                    "source": "new_annovar_filter/sample_name"
                },
                {
                    "id": "result",
                    "default": "filter_trans.vcf"
                },
                {
                    "id": "raw_vcf",
                    "source": "raw_vcf"
                }
            ],
            "out": [
                {
                    "id": "filter_transed_vcf"
                }
            ],
            "run": "./txt2vcf.cwl",
            "label": "txt2vcf",
            "sbg:x": 348.492919921875,
            "sbg:y": -273.44256591796875
        }
    ],
    "requirements": []
}